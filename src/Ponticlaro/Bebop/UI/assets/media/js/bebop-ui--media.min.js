!function(a,b,c,d){a.Bebop=a.Bebop||{};Bebop.Media=Backbone.View.extend({events:{"click [bebop-media--action]":"doAction"},initialize:function(a){if(this.$el=d(a.el),this.$el.prop("bebop-media--initialized")===c){this.$el.prop("bebop-media--initialized",!0);var e=d(b.body);this.templates={main:e.find('[bebop-media--template="main"]').html().trim(),image:e.find('[bebop-media--template="image-view"]').html().trim(),nonImage:e.find('[bebop-media--template="non-image-view"]').html().trim(),empty:e.find('[bebop-media--template="empty-view"]').html().trim(),error:e.find('[bebop-media--template="error-view"]').html().trim(),loading:e.find('[bebop-media--template="loading-view"]').html().trim()},this.$el.append(this.templates.main),this.$previewer=this.$el.find('[bebop-media--el="previewer"]'),this.$actions=this.$el.find('[bebop-media--el="actions"]'),this.$dataContainer=this.$el.find("input"),this.status=new Backbone.Model({view:"loading",id:a.id!=c?a.id:this.$dataContainer.val(),data:null});var f=this.$el.attr("bebop-media--config");this.config=new Backbone.Model(f?JSON.parse(f):{}),this.$el.attr("bebop-media--config",null),this.fieldName=this.config.get("field_name"),this.mediaPicker=wp.media({frame:"select",multiple:!1,title:this.config.get("title"),library:{type:this.config.get("mime_types")},button:{text:this.config.get("button_text")}}),this.mediaPicker.on("select",function(){var a=this.mediaPicker.state().get("selection").toJSON(),b=a.length>0?a[0]:null;b&&(this.status.set("data",b),this.status.set("id",b.id),"image"==b.type?this.status.set("view","image"):this.status.set("view","nonImage")),this.render()},this),this.listenTo(this.status,"change:view",this.render),this.listenTo(this.status,"change:data",this.handleNewData),"loading"==this.status.get("view")&&this.status.get("id")?this.fetchMedia():this.status.set("view","empty"),this.render()}},doAction:function(a){a.preventDefault();var b=d(a.currentTarget).attr("bebop-media--action");this[b]!=c&&this[b](a)},storeData:function(){this.$dataContainer.val(this.status.get("id")).trigger("change")},select:function(){this.mediaPicker.open()},remove:function(){this.status.set("data",null)},fetchMedia:function(){var a=this,b=location.protocol+"//"+location.host+"/_bebop/api/posts/"+this.status.get("id");d.ajax({url:b,type:"GET",dataType:"json",success:function(b){b?a.status.set("data",b):a.status.set("data",null)},error:function(b){a.status.set("data",{error:!0,status:b.status,message:b.statusText})}})},handleNewData:function(){var a=this.status.get("data");a?a.error!=c&&a.error?this.status.set("view","error"):(a.ID!=c||a.id!=c)&&(id=a.id!=c?a.id:a.ID,typeValue=a.post_mime_type!=c?a.post_mime_type:a.mime,view=-1!=typeValue.indexOf("image")?"image":"nonImage",a.title=a.post_title!=c?a.post_title:a.title,a.url="image"==a.type?a.sizes.thumbnail!=c?a.sizes.thumbnail.url:a.url:a.permalink!=c?a.permalink:a.url,this.status.set("id",id),this.status.set("view",view)):(this.status.set("id",""),this.status.set("view","empty")),this.storeData()},render:function(){var a=this.status.previous("view"),b=this.status.get("view"),d=this.status.get("data"),e=Mustache.render(this.templates[b],d);return this.$el.removeClass("view--"+a).addClass("view--"+b),this.$actions.find('[bebop-media--action="select"] b').text(d&&d.url!=c?"Change":"Select"),this.$previewer.html(e),this}})}(window,document,void 0,jQuery||$),function(a,b,c,d){d(function(){d.each(d('[bebop-media--el="container"]'),function(a,b){new Bebop.Media({el:b})})})}(window,document,void 0,jQuery||$);